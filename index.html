<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Light Show</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap">
</head>

<body>

    <template id="template-mode-item">
        <div class="mode-name"></div>
        <div class="mode-color"></div>
    </template>

    <div id="mode-list"></div>

    <div id="curr-label" class="label">Current</div>
    <div id="next-label" class="label">Next</div>

    <div id="rate-label" class="label">BPM</div>
    <div id="rate-curr" class="value"></div>
    <input type="number" id="rate-next" class="value">

    <div id="mode-label" class="label">Mode</div>
    <div id="mode-curr" class="value"></div>
    <div id="mode-next" class="value"></div>

    <div id="apply-button">Apply (space)</div>

</body>

<script>
    function socketInit() {
        console.log("socket init");

        socket = new WebSocket("ws://192.168.86.54:8765");

        socket.onopen = function () {
            console.log("socket open");

            socketAttempts = 0;

            if (!socketConnected) {
                socketConnected = true;
            }
        }

        socket.onclose = function () {
            console.log("socket close");
            if (socketConnected) {
                socketConnected = false;
            }
            let delay = 3000;
            if (socketAttempts == 0) {
                delay = 0;
            }
            setTimeout(() => {
                if (socket.readyState == WebSocket.CLOSED) {
                    socketInit();
                }
            }, delay);

            socketAttempts++;
        }

        socket.onerror = function () {
            console.log("socket error");
            socket.close();
        }

        socket.onmessage = function (event) {
            console.log("socket message");
            let msg = JSON.parse(event.data);
            console.log(msg);
            
            if(msg.config){
                config = msg.config
                for(let name in config){
                    modeElems[name] = new ModeItem(name);
                    modeListElem.append(modeElems[name]);
                }
            }

            if(msg.status){
                setRate(msg.status.rate)
                setMode(msg.status.mode)

                if(startTime){
                    //console.log(Date.now() - startTime);
                }
            }
        }
    }

    function setRate(rate){
        rateCurr = rate;
        rateCurrElem.textContent = rateCurr;
        
        if(rateNext == false){
            rateNext = rateCurr;
            rateNextElem.value = rateNext;
        }
    }

    function setMode(mode){
        if (modeCurr){
            modeElems[modeCurr].classList.remove('mode-curr');
        }
        modeCurr = mode;
        if (modeCurr){
            modeElems[modeCurr].classList.add('mode-curr');
        }
        modeCurrElem.textContent = modeCurr;

        if(modeNext == false){
            setNextMode(modeCurr);
        }
    }

    function setNextMode(mode){
        if (modeNext){
            modeElems[modeNext].classList.remove('mode-next');
        }
        modeNext = mode;
        if (modeNext){
            modeElems[modeNext].classList.add('mode-next');
        }
        modeNextElem.textContent = modeNext;
    }

    class ModeItem extends HTMLElement {
        constructor(name) {
            super();

            this.appendChild(templateModeItem.content.cloneNode(true));

            this.name = name;

            this.nameElem = this.querySelector(".mode-name");
            this.nameElem.textContent = this.name;

            //this.colorElem = this.querySelector(".mode-color");

            this.onclick = function () {
                //event.stopPropagation();
                setNextMode(this.name);
            };
        }
    }
    customElements.define('mode-item', ModeItem);

    var socket = null;
    var socketConnected = false;
    var socketAttempts = 0;

    var startTime = false;
    var listScroll = 0;

    var modeElems = {};
    var modeListElem = document.getElementById("mode-list");

    var templateModeItem = document.getElementById("template-mode-item");

    var config = {};

    var rateCurr = false;
    var rateNext = false;
    var modeCurr = false;
    var modeNext = false;

    var rateCurrElem = document.getElementById("rate-curr");
    var rateNextElem = document.getElementById("rate-next");
    var modeCurrElem = document.getElementById("mode-curr");
    var modeNextElem = document.getElementById("mode-next");
    var applyElem = document.getElementById("apply-button");

    rateNextElem.focus();

    rateNextElem.onblur = function(){
        fixRate();
    }

    function fixRate(){
        rateNextElem.value = Math.max(0.01, Math.min(600, rateNextElem.value));
    }

    applyElem.onclick = function () {
        fixRate();
        let msg = {
            type: "start",
            rate: rateNextElem.value,
            mode: modeNext
        };
        socket.send(JSON.stringify(msg));
        console.log(msg)
        startTime = Date.now();
    }

    document.addEventListener('keydown', (e) => {
        if(e.keyCode == 32){ // space
            applyElem.click();
        }else if(e.keyCode == 87 || e.keyCode == 83){ // w + s
            var num = 0;
            var found = 0;
            for(var mode in modeElems){
                if(mode == modeNext){
                    found = num;
                }
                num++;
            }
            num = 0;
            if(e.keyCode == 87){
                found--;
            }else if(e.keyCode == 83){
                found++;
            }
            for(var mode in modeElems){
                if(num == found){
                    setNextMode(mode);
                }
                num++;
            }

            var margin = window.innerWidth*0.005;
            console.log("SCROLL");
            
            var topScroll = Math.round(modeElems[modeNext].offsetTop - margin);
            var bottomScroll = Math.round(modeElems[modeNext].offsetTop + modeElems[modeNext].offsetHeight + margin - modeListElem.offsetHeight);

            console.log(listScroll);
            console.log(topScroll);
            console.log(bottomScroll);

            if(topScroll < listScroll){
                listScroll = topScroll;
                modeListElem.scrollTo({
                    top: listScroll,
                    left: 0,
                    behavior: 'smooth'
                });
            }else if(bottomScroll > listScroll){
                listScroll = bottomScroll;
                modeListElem.scrollTo({
                    top: listScroll,
                    left: 0,
                    behavior: 'smooth'
                });
            }
        }else if((e.keyCode >= 48 && e.keyCode <= 57) || (e.keyCode >= 37 && e.keyCode <= 40) || e.keyCode == 190 || e.keyCode == 8){
            rateNextElem.focus();
        }
        //console.log(e.keyCode)
    });

    socketInit();

</script>

<style>
    body {
        color-scheme: dark;
        height: 100vh;
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        font-size: 0;
        color: hsl(0, 0%, 80%);
        background-color: hsl(0, 0%, 4%);
    }

    #mode-list{
        position: absolute;
        width: 35%;
        height: 100%;
        background-color: hsl(0, 0%, 8%);
        overflow: auto;
    }

    mode-item {
        display: block;
        width: calc(100% - 1vw);
        height: 10vh;
        margin: 0.5vw;
        border-radius: 1vw;
        background-color: hsl(0, 0%, 12%);
        text-align: center;
        font-size: 3vh;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    .mode-curr{
        background-color: hsl(120, 100%, 30%);
    }

    .mode-next{
        background-color: hsl(204, 100%, 30%);
    }

    .label {
        position: absolute;
        width: 12%;
        height: 6%;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .value {
        position: absolute;
        width: 12%;
        height: 6%;
        border-radius: 1vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsl(0, 0%, 8%);
    }

    #curr-label {
        left: 60%;
        top: 15%;
    }

    #next-label {
        left: 75%;
        top: 15%;
    }

    #rate-label {
        left: 45%;
        top: 25%;
    }

    #rate-curr {
        left: 60%;
        top: 25%;
    }

    #rate-next {
        left: 75%;
        top: 25%;
        box-sizing: border-box;
        border: none;
        border-bottom: hsl(0, 0%, 50%) 1px solid;
    }

    #mode-label {
        left: 45%;
        top: 35%;
    }

    #mode-curr {
        left: 60%;
        top: 35%;
    }

    #mode-next {
        left: 75%;
        top: 35%;
    }


    #apply-button{
        position: absolute;
        left: 55%;
        top: 50%;
        width: 25%;
        height: 8%;
        border-radius: 1vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsl(204, 100%, 30%);
        cursor: pointer;
    }

    #apply-button:active{
        opacity: 0.8;
        transform: scale(0.97);
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Firefox */
    input[type=number] {
        -moz-appearance: textfield;
    }
    

    ::-webkit-scrollbar {
        width: 1vw;
    }

    ::-webkit-scrollbar-thumb {
        background: hsl(0, 0%, 20%);
        border-radius: 1vw;
    }

</style>

</html>