<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#000000">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <title>DJ Lights</title>
    <link rel="manifest" href="lights-manifest.webmanifest">
    <link rel="icon" href="lights_icons/icon48.png">
    <link rel="apple-touch-icon" href="lights_icons/icon180.png" sizes="180x180">
</head>

<body tabindex="-1">

    <template id="template-effect-button">
        <div class="button-symbol"></div>
        <div class="button-name"></div>
        <div class="button-bpm"></div>
        <div class="button-length"></div>
        <div class="button-loop"></div>
        <div class="button-trigger"></div>
    </template>

    <template id="template-profile-button">
        <div class="profile-name"></div>
        <div class="profile-playing"></div>
    </template>

    <canvas id="background" width="200" height="200"></canvas>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="slider-container">
                <input type="range" min="0" max="360" value="0" class="slider" id="hue">
                <span id="hueValue">0</span>
            </div>

            <div class="slider-container">
                <label for="saturation">Saturation</label>
                <input type="range" min="-100" max="100" value="0" class="slider" id="saturation">
                <span id="saturationValue">0</span>
            </div>

            <div class="slider-container">
                <label for="lightness">Lightness</label>
                <input type="range" min="-100" max="100" value="0" class="slider" id="lightness">
                <span id="lightnessValue">0</span>
            </div>

            <div class="slider-container">
                <label for="sensitivity">Sensitivity</label>
                <input type="range" min="0" max="2" value="1" step="0.01" class="slider" id="sensitivity">
                <span id="sensitivityValue">1</span>
            </div>

            <div class="slider-container">
                <label for="rating">Rating</label>
                <input type="range" min="0" max="5" value="0" step="1" class="slider" id="rating">
                <span id="ratingValue">0</span>
            </div>
        </div>
    </div>

    <div id="profile-box"></div>

    <div id="effects-box">
        <div class="effects-table"></div>
        <div class="effects-table"></div>
    </div>
    <div id="page-up" class="button">Up</div>
    <div id="page-label">0/0</div>
    <div id="page-down" class="button">Dn</div>
    <div id="page-random" class="button">random</div>
    <div id="page-modifier" class="button">modify</div>
    <!-- <div id="beat-sens" class="text">Beat Sens: N/A</div>
    <div id="beat-sens-up" class="button">Beat up</div>
    <div id="beat-sens-down" class="button">Beat down</div> -->
    <div id="refresh" class="button">Refresh</div>
    <div id="laser-mode" class="button gray">Laser Mode</div>
    <div id="clear" class="button">Clear</div>
    <div id="dev-mode" class="button gray">Dev Mode</div>
</body>

<script>
    function socketInit() {
        console.log("socket init");
        
        let connectHost = location.hostname;
        const isIpAddress = /^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/.test(connectHost);
        if (!isIpAddress && connectHost.split('.').length > 2) {
            const parts = connectHost.split('.');
            connectHost = parts.slice(-2).join('.');
        }
        const string_to_connect = "wss://" + connectHost + ":1337"
        console.log("Connecting to websocket:", string_to_connect);
        socket = new WebSocket(string_to_connect);

        socket.onopen = function () {
            // sometimes takes a long time to get here
            console.log("socket open");

            socketAttempts = 0;

            if (!socketConnected) {
                socketConnected = true;
            }
        }

        socket.onclose = function () {
            console.log("socket close");
            if (socketConnected) {
                socketConnected = false;
            }
            let delay = 3000;
            if (socketAttempts == 0) {
                delay = 0;
            }
            setTimeout(() => {
                if (socket.readyState == WebSocket.CLOSED) {
                    socketInit();
                }
            }, delay);

            socketAttempts++;
        }

        socket.onerror = function () {
            console.log("socket error");
            socket.close();
        }

        socket.onmessage = function (event) {
            // console.log("socket message");
            let msg = JSON.parse(event.data);
            // console.log('Receiving:', msg);

            if(msg.songs){
                songsConfig = msg.songs;
            }

            if(msg.effects){
                if(Object.keys(effectsConfig).length === 0){
                    effectsConfig = msg.effects;
                    for(let effectName in effectsConfig){
                        // !TODO this is ugly, just dont send...
                        // if (effectName.startsWith('g_')) {
                        //     continue
                        // }

                        for(let profileName of effectsConfig[effectName].profiles){
                            if(!(profileName in profileButtons)){
                                profileButtons[profileName] = new ProfileButton(profileName, profileOrder[profileName] ?? 1000);
                                profileEffects[profileName] = [];
                                effectButtonIndex[profileName] = {};
                                profileEffectsIndex[profileName] = 0;
                            }
                            effectButtonIndex[profileName][effectName] = profileEffects[profileName].length;
                            profileEffects[profileName].push(effectName);
                        }
                    }
                    profilesArray = Object.values(profileButtons);
                    profilesArray.sort((a, b) => a.prescendence - b.prescendence);
                    for (let profile of profilesArray) {
                        profileBox.append(profile);
                    }
                    profileBox.children[0].activate();
                    init = true;
                }
            }

            if(msg.update_winamp_offsets){
                console.log(msg)
                let winampOffsets = msg.update_winamp_offsets;

                for (winampUpdate of winampOffsets) {
                    let effectName = winampUpdate.effect_name;
                    if (effectsConfig[effectName] != null) {
                        effectsConfig[effectName].winamp_offsets = {
                            'winamp_bright_shift': winampUpdate.winamp_bright_shift / 100,
                            'winamp_hue_shift': winampUpdate.winamp_hue_shift / 360,
                            'winamp_sat_shift': winampUpdate.winamp_sat_shift / 100,
                            'winamp_beat_sensitivity': winampUpdate.winamp_beat_sensitivity,
                            'rating': winampUpdate.rating
                        };
                        console.log('Updated winamp offsets for effect:', effectName, effectsConfig[effectName].winamp_offsets);

                        // need to adjust the sliders if the effect is active, calls setCurrentWinampValueSliders() on the current effect
                        let index = effectButtonIndex[activeProfile][effectName];
                        if (index >= profileEffectsIndex[activeProfile] && index < profileEffectsIndex[activeProfile] + 25){
                            if (effectButtons[activeTable][index % 25]) {
                                effectButtons[activeTable][index % 25].setCurrentWinampValueSliders();
                            }
                        }

                    } else {
                        console.warn('Effect not found in config:', effectName);
                    }   
                }
            }

            if(msg.status){
                // if (msg.status.beat_sens_string) {
                //     beatSensElem.textContent = msg.status.beat_sens_string;
                // }
                if ('effects' in msg.status){
                    let effectsPrev = effectsCurr;
                    effectsCurr = {};
                    for(let effectArr of msg.status.effects){
                        effectName = effectArr[0];
                        effectsCurr[effectName] = true;
                    }
                    for(effectName in effectsPrev){
                        if(effectsCurr[effectName] == null && effectsConfig[effectName] != null){
                            for(let profileName of effectsConfig[effectName].profiles){
                                profileButtons[profileName].decreasePlaying();
                                if(profileName == activeProfile){
                                    let index = effectButtonIndex[activeProfile][effectName];
                                    if (index >= profileEffectsIndex[activeProfile] && index < profileEffectsIndex[activeProfile] + 25){
                                        effectButtons[activeTable][index % 25].deactivate();
                                    }
                                }
                            }
                        }
                    }
                    for(let effectName in effectsCurr){
                        if(effectsPrev[effectName] == null && effectsConfig[effectName] != null){
                            for(let profileName of effectsConfig[effectName].profiles){
                                profileButtons[profileName].increasePlaying();
                                if(profileName == activeProfile){
                                    let index = effectButtonIndex[activeProfile][effectName];
                                    if (index >= profileEffectsIndex[activeProfile] && index < profileEffectsIndex[activeProfile] + 25){
                                        effectButtons[activeTable][index % 25].activate();
                                    }
                                }
                            }
                        }
                    }
                }
                
                if ('laser_mode' in msg.status) {
                    if(msg.status.laser_mode != laserMode){
                        if (msg.status.laser_mode){
                            laserModeElem.classList.remove('gray');
                        } else {
                            laserModeElem.classList.add('gray');
                        }
                        laserMode = msg.status.laser_mode;
                    }
                }

                if ('dev_mode' in msg.status) {
                    if(msg.status.dev_mode != devMode){
                        if (msg.status.dev_mode) {
                            devModeElem.classList.remove('gray');
                        } else {
                            devModeElem.classList.add('gray');
                        }
                        devMode = msg.status.dev_mode;
                    }
                }
            }
        }
    }

    /////////////////////////////////////////////////////////////////////

    class EffectButton extends HTMLElement {
        constructor() {
            super();

            this.appendChild(templateEffectButton.content.cloneNode(true));

            this.nameElem = this.querySelector('.button-name');
            this.durationElem = this.querySelector('.button-length');
            this.triggerElem = this.querySelector('.button-trigger');
            this.bpmElem = this.querySelector('.button-bpm');
            this.loopElem = this.querySelector('.button-loop');
            
            this.active = false;
            this.pressed = false;

            if (navigator.userAgent.includes('Mobi')) {
                this.addEventListener('touchstart', this.press, {passive: true});
                this.addEventListener('touchend', this.release, {passive: true});
                this.addEventListener('touchcancel', this.release, {passive: true});
            } else {
                this.addEventListener('mousedown', this.press, {passive: true});
                this.addEventListener('mouseup', this.release, {passive: true});
                this.addEventListener('wheel', this.wheel, {passive: true});
            }
        }

        changeEffect(effect){
            this.release();
            this.deactivate();
            if(effect == null){
                this.style.visibility = 'hidden';
            }else{
                this.style.visibility = 'visible';
                this.effect = effect;

                if(effectsCurr[this.effect]){
                    this.activate();
                }

                this.trigger = effectsConfig[this.effect].trigger;
                this.toggle = this.trigger == 'toggle';
                this.hold = this.trigger == 'hold';
                this.add = this.trigger == 'add';

                if(effectsConfig[this.effect].loop){
                    this.loopElem.textContent = 'âˆž';
                }
                if(effectsConfig[this.effect].bpm){
                    this.bpmElem.textContent = effectsConfig[this.effect].bpm + ' bpm';
                }

                this.nameElem.textContent = this.effect;
                
                this.durationElem.textContent = decimal(effectsConfig[this.effect].length, 2);
                this.triggerElem.textContent = this.trigger;
            }
        }

        press(event){
            if (!this.effect) {
                console.log('Somehow press was called without this.effect existing');
                return
            }
            // event.preventDefault();
            this.pressed = true;
            if(this.toggle){
                if(this.active){
                    removeEffect(this.effect);
                }else{
                    addEffect(this.effect);
                }
            }else{
                addEffect(this.effect);
            }
            this.classList.add('effect-button-pressed');
        }

        release(event){
            // event.preventDefault();
            if(this.pressed){
                this.pressed = false;
                if(this.hold){
                    removeEffect(this.effect);
                }
                this.classList.remove('effect-button-pressed');
            }
        }

        wheel(event) {
            if (event.deltaY > 0) {
                pageDown();
            } else if (event.deltaY < 0) {
                pageUp();
            }
        }

        setCurrentWinampValueSliders() {
            console.log('LOOK AT ME: winamp_offsets', effectsConfig[this.effect].winamp_offsets);

            // adjusts all the sliders to the winamp offsets
            let the_winamp_offsets = {
                'winamp_hue_shift': 0,
                'winamp_sat_shift': 0,
                'winamp_bright_shift': 0,
                'winamp_beat_sensitivity': 1,
                'rating': 0
            }
            if (effectsConfig[this.effect].winamp_offsets) {
                the_winamp_offsets = effectsConfig[this.effect].winamp_offsets;
            }
            let hueSlider = document.getElementById('hue');
            if (hueSlider) {
                hueSlider.value = the_winamp_offsets['winamp_hue_shift'] * 360;
                document.getElementById('hueValue').textContent = hueSlider.value;
            }
            let saturationSlider = document.getElementById('saturation');
            if (saturationSlider) {
                saturationSlider.value = the_winamp_offsets['winamp_sat_shift'] * 100;
                document.getElementById('saturationValue').textContent = saturationSlider.value;
            }
            let lightnessSlider = document.getElementById('lightness');
            if (lightnessSlider) {
                lightnessSlider.value = the_winamp_offsets['winamp_bright_shift'] * 100;
                document.getElementById('lightnessValue').textContent = lightnessSlider.value;
            }
            let sensitivitySlider = document.getElementById('sensitivity');
            if (sensitivitySlider) {
                sensitivitySlider.value = the_winamp_offsets['winamp_beat_sensitivity'];
                document.getElementById('sensitivityValue').textContent = sensitivitySlider.value;
            }
            let ratingSlider = document.getElementById('rating');
            if (ratingSlider) {
                ratingSlider.value = the_winamp_offsets['rating'];
                document.getElementById('ratingValue').textContent = ratingSlider.value;
            }
        }

        activate(){
            if(!this.active){
                this.classList.add('effect-button-active');
                this.active = true;
                this.setCurrentWinampValueSliders()
            }
        }

        deactivate(){
            if(this.active){
                this.classList.remove('effect-button-active');
                this.active = false;
            }
        }
    }
    customElements.define('effect-button', EffectButton);


    class ProfileButton extends HTMLElement {
        constructor(profileName, prescendence) {
            super();

            this.appendChild(templateProfileButton.content.cloneNode(true));

            this.profileName = profileName;

            this.prescendence = prescendence;

            this.nameElem = this.querySelector('.profile-name');
            this.nameElem.textContent = this.profileName;

            this.playingElem = this.querySelector('.profile-playing');

            this.active = false;

            this.playing = 0;

            this.onclick = function (event) {
                event.preventDefault();
                profileButtons[activeProfile].deactivate();
                this.activate();
            };
        }

        setPlaying(){
            if(this.playing == 0){
                this.playingElem.textContent = '';
            }else{
                this.playingElem.textContent = this.playing;
            }
        }

        increasePlaying(){
            this.playing++;
            if(this.playing == 0){
                this.playingElem.textContent = '';
            }else{
                this.playingElem.textContent = this.playing;
            }
        }

        decreasePlaying(){
            this.playing--;
            if(this.playing == 0){
                this.playingElem.textContent = '';
            }else{
                this.playingElem.textContent = this.playing;
            }
        }

        activate(){
            if(!this.active){
                this.classList.add('profile-button-active');
                this.active = true;
                activeProfile = this.profileName;
                
                // if it contains the word 'winamp' in either case
                if (this.profileName.toLowerCase().includes('winamp')) {
                    randomButton.style.display = 'flex';
                    modifyButton.style.display = 'flex';
                } else {
                    randomButton.style.display = 'none';
                    modifyButton.style.display = 'none';
                }

                updateEffectButtons();
                effectsTables[activeTable].style.animationName = 'curr-table-activate';
                effectsTables[activeTable].style.zIndex = 2;
                if(init){
                    effectsTables[1 - activeTable].style.animationName = 'prev-table-deactivate';
                    effectsTables[1 - activeTable].style.zIndex = 1;
                }
            }
        }

        deactivate(){
            if(this.active){
                this.classList.remove('profile-button-active');
                this.active = false;
                activeProfile = null;
            }
        }
    }
    customElements.define('profile-button', ProfileButton);


    
    function addEffect(effect){
        if (effect.toLowerCase().includes('accel')) {
            trackAccel = true;
        }
        
        let msg = {
            type: 'add_effect',
            effect: effect
        };
        send(JSON.stringify(msg));
        // console.log('Sending:', msg);
    }

    function removeEffect(effect){
        if (effect.toLowerCase().includes('accel')) {
            trackAccel = false;
        }

        let msg = {
            type: 'remove_effect',
            effect: effect
        };
        send(JSON.stringify(msg));
        // console.log('Sending:', msg);
    }

    function sendToggleLaserMode(){
        let msg = {
            type: 'toggle_laser_mode',
        };
        send(JSON.stringify(msg));
        // console.log('Sending:', msg);
    }

    function sendUpdate(){
        let msg = {
            type: 'update_config'
        };
        send(JSON.stringify(msg));
        // console.log('Sending:', msg);
    }

    function sendClear(){
        let msg = {
            type: 'clear_effects'
        };
        send(JSON.stringify(msg));
        // console.log('Sending:', msg);
    }

    function sendDevMode(){
        let msg = {
            type: 'toggle_dev_mode',
        };
        send(JSON.stringify(msg));
        // console.log('Sending:', msg);
    }

    var socket = null;
    var socketConnected = false;
    var socketAttempts = 0;

    var uuid = localStorage.getItem('uuid');
    if (uuid == null) {

        let array = new Uint8Array(16);
        self.crypto.getRandomValues(array);
        var uuid = '';
        for (let i = 0; i < 16; i++) {
            if (i == 4 || i == 6 || i == 8 || i == 10) {
                uuid += '-';
            }
            uuid += array[i].toString(16);
        };

        localStorage.setItem('uuid', uuid)
        console.log('new user: ' + uuid);
    }
    console.log('----UUID----')
    console.log(uuid);

    function send(msg){
        if(socket != null && socket.readyState == WebSocket.OPEN){
            socket.send(msg);
        } else {
            console.log('socket == null', socket == null);
            console.log('socket.readyState', socket ? socket.readyState : 'undefined');
        }
    }


    // Function to create a rotation matrix for a given angle (in radians) around the Z axis
    function createRotationMatrixZ(angleRad) {
        return [
            [Math.cos(angleRad), -Math.sin(angleRad), 0],
            [Math.sin(angleRad), Math.cos(angleRad), 0],
            [0, 0, 1]
        ];
    }

    // Function to apply a rotation matrix to a vector
    function applyRotationMatrix(rotationMatrix, vector) {
        return {
            x: rotationMatrix[0][0] * vector.x + rotationMatrix[0][1] * vector.y + rotationMatrix[0][2] * vector.z,
            y: rotationMatrix[1][0] * vector.x + rotationMatrix[1][1] * vector.y + rotationMatrix[1][2] * vector.z,
            z: rotationMatrix[2][0] * vector.x + rotationMatrix[2][1] * vector.y + rotationMatrix[2][2] * vector.z
        };
    }

    // Function to convert quaternion to rotation matrix
    function quaternionToRotationMatrix(q) {
        let x2 = q.x * q.x;
        let y2 = q.y * q.y;
        let z2 = q.z * q.z;
        let xy = q.x * q.y;
        let xz = q.x * q.z;
        let yz = q.y * q.z;
        let wx = q.w * q.x;
        let wy = q.w * q.y;
        let wz = q.w * q.z;

        return [
            [1 - 2 * (y2 + z2), 2 * (xy - wz), 2 * (xz + wy)],
            [2 * (xy + wz), 1 - 2 * (x2 + z2), 2 * (yz - wx)],
            [2 * (xz - wy), 2 * (yz + wx), 1 - 2 * (x2 + y2)]
        ];
    }

    // Function to get the ground plane intersection for the device's Y-axis with a rotated ground plane
    function getDeviceYAxisIntersectionWithGroundRotatedZ(quaternion, deviceHeightBelowGround, groundPlaneRotationAngle) {
        // Convert quaternion to rotation matrix
        let rotationMatrix = quaternionToRotationMatrix(quaternion);

        // The device's Y-axis direction is represented by the second column of the rotation matrix
        let deviceYAxisDirection = {
            x: rotationMatrix[0][1],
            y: rotationMatrix[1][1],
            z: rotationMatrix[2][1]
        };

        // Find where the device's Y-axis intersects with the standard ground plane (Z = 0)
        let t = deviceHeightBelowGround / deviceYAxisDirection.z; // Solve for intersection with Z=0
        let intersectionX = deviceYAxisDirection.x * t;
        let intersectionY = deviceYAxisDirection.y * t;

        // Apply the ground plane's Z-axis rotation
        let groundRotationMatrixZ = createRotationMatrixZ(groundPlaneRotationAngle);
        let intersectionRotated = applyRotationMatrix(groundRotationMatrixZ, { x: intersectionX, y: intersectionY, z: 0 });

        return { x: intersectionRotated.x, y: intersectionRotated.y };
    }

    
    // const acl = new Accelerometer({ frequency: 60 });
    // acl.addEventListener("reading", () => {
    //     // beatSensElem.textContent = `x: ${acl.x.toFixed(2)}, y: ${acl.y.toFixed(2)}, z: ${acl.z.toFixed(2)}`;
    //     // beatSensElem.textContent = `pitch: ${pitch.toFixed(2)}, roll: ${roll.toFixed(2)}`
    //     if (trackAccel) {
    //         let pitch = Math.atan2(acl.z, acl.y);
    //         let roll = Math.atan2(acl.x, acl.y);
    //         let msg = {
    //             type: 'accel',
    //             x: roll * 13,
    //             y: pitch * 13,
    //             z: acl.z
    //         };
    //         send(JSON.stringify(msg));
    //     }
    // });
    // acl.start();
    

    var profileOrder = {
        'winamp rated 5': -6,
        'winamp rated 4': -5,
        'winamp rated 3': -4,
        'winamp rated 2': -3,
        'winamp rated 1': -2,
        'winamp_all': -1,
        'Andrew': 0,
        'Eric': 1,
        'Emma': 2,
        'Fun Grid': 3,
        'Winamp Alone': 4,
        'Winamp Good 2': 5,
        'Colors': 10,
        'winamp_good_1': 14,
        'winamp_tests': 15,
        'Shows': 16,        
        'Autogen effects': 99999,
        'Generated Shows': 100000,
    }

    var effectsConfig = {};
    var songsConfig = {};
    
    var effectButtons = [];
    var profileButtons = {};

    var profileEffects = {};

    var effectButtonIndex = {};


    const randomButton = document.getElementById('page-random');
    randomButton.style.display = 'none';

    const modifyButton = document.getElementById('page-modifier');
    modifyButton.style.display = 'none';

    var modal = document.getElementById("myModal");
    var span = document.getElementsByClassName("close-button")[0];
    var hue = document.getElementById("hue");
    var hueValue = document.getElementById("hueValue");
    var saturation = document.getElementById("saturation");
    var saturationValue = document.getElementById("saturationValue");
    var lightness = document.getElementById("lightness");
    var lightnessValue = document.getElementById("lightnessValue");
    var sensitivity = document.getElementById("sensitivity");
    var sensitivityValue = document.getElementById("sensitivityValue");
    var rating = document.getElementById("rating");
    var ratingValue = document.getElementById("ratingValue");
    const sliders = document.querySelectorAll('.slider');

    var profileBox = document.getElementById('profile-box');

    var effectsBox = document.getElementById('effects-box');
    var effectsTables = effectsBox.querySelectorAll('.effects-table');

    var templateEffectButton = document.getElementById('template-effect-button');
    var templateProfileButton = document.getElementById('template-profile-button');

    var effectsCurr = {};
    var activeProfile = null;
    var activeTable = 0;

    var devMode = false;
    var laserMode = false;

    for(let i=0; i<2; i++){
        effectButtons[i] = [];
        for(let j=0; j<25; j++){
            effectButtons[i][j] = new EffectButton();
            effectsTables[i].append(effectButtons[i][j]);
        }
    }

    function updateEffectButtons(){
        activeTable = 1 - activeTable;
        for(let i=0; i<25; i++){
            let index = i + profileEffectsIndex[activeProfile]
            if(i < profileEffects[activeProfile].length){
                effectButtons[activeTable][i].changeEffect(profileEffects[activeProfile][index]);
            }else{
                effectButtons[activeTable][i].changeEffect(null);
            }
        }
        pageLabelElem.textContent = (Math.floor(profileEffectsIndex[activeProfile] / 25) + 1) + '/' + Math.ceil(profileEffects[activeProfile].length / 25);
    }

    var profileEffectsIndex = {};

    var init = false;

    var pageUpElem = document.getElementById('page-up');
    var pageLabelElem = document.getElementById('page-label');
    var pageDownElem = document.getElementById('page-down');

    function pageUp(){
        if(profileEffectsIndex[activeProfile] - 25 >= 0){
            profileEffectsIndex[activeProfile] -= 25;
            updateEffectButtons();
            effectsTables[activeTable].style.animationName = 'curr-table-up';
            effectsTables[1 - activeTable].style.animationName = 'prev-table-up';
        }
    }

    function pageDown(){
        if(profileEffectsIndex[activeProfile] + 25 < profileEffects[activeProfile].length){
            profileEffectsIndex[activeProfile] += 25;
            updateEffectButtons();
            effectsTables[activeTable].style.animationName = 'curr-table-down';
            effectsTables[1 - activeTable].style.animationName = 'prev-table-down';
        }
    }

    var pageInterval = null;

    if (navigator.userAgent.includes('Mobi')) {
        pageUpElem.addEventListener('touchstart', ()=>{
            clearInterval(pageInterval);
            pageUp();
            pageInterval = setInterval(()=>{
                pageUp();
            }, 200);
        }, {passive: true});

        pageUpElem.addEventListener('touchend', ()=>{
            clearInterval(pageInterval);
        }, {passive: true});

        pageUpElem.addEventListener('touchcancel', ()=>{
            clearInterval(pageInterval);
        }, {passive: true});

        pageDownElem.addEventListener('touchstart', ()=>{
            clearInterval(pageInterval);
            pageDown();
            pageInterval = setInterval(()=>{
                pageDown();
            }, 200);
        }, {passive: true});

        pageDownElem.addEventListener('touchend', ()=>{
            clearInterval(pageInterval);
        }, {passive: true});

        pageDownElem.addEventListener('touchcancel', ()=>{
            clearInterval(pageInterval);
        }, {passive: true});


        // Update the slider value display
        // hue.oninput = function() {
        //     hueValue.innerHTML = this.value;
        // }

        // lightness.oninput = function() {
        //     lightnessValue.innerHTML = this.value;
        // }
        // saturation.oninput = function() {
        //     saturationValue.innerHTML = this.value;
        // }
        // sensitivity.oninput = function() {
        //     sensitivityValue.innerHTML = this.value;
        // }

    } else {
        pageUpElem.addEventListener('mousedown', ()=>{
            clearInterval(pageInterval);
            pageUp();
            pageInterval = setInterval(()=>{
                pageUp();
            }, 250);
        }, {passive: true});

        pageUpElem.addEventListener('mouseup', ()=>{
            clearInterval(pageInterval);
        }, {passive: true});

        pageDownElem.addEventListener('mousedown', ()=>{
            clearInterval(pageInterval);
            pageDown();
            pageInterval = setInterval(()=>{
                pageDown();
            }, 250);
        }, {passive: true});

        pageDownElem.addEventListener('mouseup', ()=>{
            clearInterval(pageInterval);
        }, {passive: true});
    }

    randomButton.addEventListener('click', ()=>{
        let randomIndex = Math.floor(Math.random() * profileEffects[activeProfile].length);

        // mod to the lowest 25
        profileEffectsIndex[activeProfile] = randomIndex - (randomIndex % 25);

        let effectName = profileEffects[activeProfile][randomIndex];
        if (effectName) {
            addEffect(effectName);
        }

        updateEffectButtons();
        effectsTables[activeTable].style.animationName = 'curr-table-up';
        effectsTables[1 - activeTable].style.animationName = 'prev-table-up';
    }, {passive: true});

    modifyButton.addEventListener('click', ()=>{
        modal.style.display = "block";
    }, {passive: true});


    span.onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    sliders.forEach(slider => {
        slider.addEventListener('input', (event) => {
            // Find the <span> element that is the next sibling of the slider
            const valueSpan = slider.nextElementSibling;

            if (valueSpan) {
                let value = event.target.value;

                if (event.target.id === 'sensitivity') {
                    value = parseFloat(value).toFixed(2);
                }
                valueSpan.textContent = value;

                console.log(`Slider ${event.target.id} changed to ${value}`);

                let msg = {
                    type: 'winamp_offset_update',
                    id: event.target.id,
                    value: value
                };
                send(JSON.stringify(msg));
            }
        });
    });

    var beatSensElem = document.getElementById('beat-sens');
    var beatSensUpElem = document.getElementById('beat-sens-up');
    var beatSensDownElem = document.getElementById('beat-sens-down');

    var refreshElem = document.getElementById('refresh');
    var laserModeElem = document.getElementById('laser-mode');
    var clearElem = document.getElementById('clear');
    var devModeElem = document.getElementById('dev-mode');

    function decimal(num, place) {
        return Math.round(num * Math.pow(10, place)) / Math.pow(10, place)
    }
    
    // beatSensUpElem.onclick = function () {
    //     beatSensUp();
    // }

    // beatSensDownElem.onclick = function () {
    //     beatSensDown();
    // }

    refreshElem.onclick = function () {
        location.reload();
    }

    laserModeElem.onclick = function () {
        sendToggleLaserMode();
    }

    clearElem.onclick = function () {
        sendClear();
    }

    devModeElem.onclick = function () {
        sendDevMode();
    }

    // window.oncontextmenu = function(event) {
    //     event.preventDefault();
    //     event.stopPropagation();
    //     return false;
    // };

    function beatSensUp() {
        let msg = {
            type: 'beat_sens_up',
        };
        send(JSON.stringify(msg));
    }
    
    function beatSensDown() {
        let msg = {
            type: 'beat_sens_down',
        };
        send(JSON.stringify(msg));
    }

    function paintBackground() {
        const ratio = window.devicePixelRatio || 1;
        background.width = window.innerWidth * ratio;
        background.height = window.innerHeight * ratio;

        let offscreenCanvas = document.createElement('canvas');
        offscreenCanvas.width = background.width;
        offscreenCanvas.height = background.height;
        let ctx = offscreenCanvas.getContext('2d');

        let bokehColor = [
            [150, 100, 30],
            [180, 100, 30],
            [210, 100, 30],
            [240, 100, 30],
            [270, 100, 30],
            [300, 100, 30],
            [330, 100, 30],
        ];

        let bokehCount = 100;
        for(let i=0; i<bokehCount; i++){
            let x = Math.random() * background.width;
            let y = Math.random() * background.height;
            let radius = background.height * 0.25;
            let color = bokehColor[Math.floor(Math.random()*bokehColor.length)];
            let grd = ctx.createRadialGradient(x, y, 0, x, y, radius);
            grd.addColorStop(0, `hsla(${color[0]}, ${color[1]}%, ${color[2]}%, 0.5)`);
            grd.addColorStop(1, `hsla(${color[0]}, ${color[1]}%, ${color[2]}%, 0)`);
            ctx.fillStyle = grd;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
        }

        let visibleCtx = background.getContext('2d');
        visibleCtx.clearRect(0, 0, background.width, background.height);
        visibleCtx.drawImage(offscreenCanvas, 0, 0);
    }

    var trackAccel = false;

    // Function to convert alpha, beta, gamma to the device's Y-axis in world coordinates
    // function getDeviceYAxisInWorldCoordinates(alpha, beta, gamma) {
    //     const degToRad = Math.PI / 180;

    //     // Convert angles from degrees to radians
    //     alpha = alpha * degToRad;
    //     beta = beta * degToRad;
    //     gamma = gamma * degToRad;

    //     beatSensElem.textContent = `a: ${alpha.toFixed(2)}, b: ${beta.toFixed(2)}, g: ${gamma.toFixed(2)}`;

    //     // Rotation matrices for each axis
    //     const Rz = [
    //         [Math.cos(alpha), -Math.sin(alpha), 0],
    //         [Math.sin(alpha), Math.cos(alpha), 0],
    //         [0, 0, 1]
    //     ];

    //     const Rx = [
    //         [1, 0, 0],
    //         [0, Math.cos(beta), -Math.sin(beta)],
    //         [0, Math.sin(beta), Math.cos(beta)]
    //     ];

    //     const Ry = [
    //         [Math.cos(gamma), 0, Math.sin(gamma)],
    //         [0, 1, 0],
    //         [-Math.sin(gamma), 0, Math.cos(gamma)]
    //     ];

    //     // Initial Y-axis vector in local device coordinates (0, 1, 0)
    //     let yAxis = { x: 0, y: 1, z: 0 };

    //     // Apply the rotations: First gamma (Y-axis), then beta (X-axis), then alpha (Z-axis)
    //     yAxis = applyRotationMatrix(Ry, yAxis);
    //     yAxis = applyRotationMatrix(Rx, yAxis);
    //     yAxis = applyRotationMatrix(Rz, yAxis);

    //     // beatSensElem.textContent = `x: ${yAxis.x.toFixed(2)}, y: ${yAxis.y.toFixed(2)}, z: ${yAxis.z.toFixed(2)}`;
    //     return yAxis;
    // }

    // // Helper function to apply a rotation matrix to a vector
    // function applyRotationMatrix(matrix, vector) {
    //     return {
    //         x: matrix[0][0] * vector.x + matrix[0][1] * vector.y + matrix[0][2] * vector.z,
    //         y: matrix[1][0] * vector.x + matrix[1][1] * vector.y + matrix[1][2] * vector.z,
    //         z: matrix[2][0] * vector.x + matrix[2][1] * vector.y + matrix[2][2] * vector.z
    //     };
    // }

    // // Example usage: Get the Y-axis in world coordinates
    // function handleOrientation(event) {
    //     const alpha = event.alpha || 0; // Z-axis rotation
    //     const beta = event.beta || 0;   // X-axis rotation
    //     const gamma = event.gamma || 0; // Y-axis rotation

    //     const yAxisInWorld = getDeviceYAxisInWorldCoordinates(alpha, beta, gamma);

    //     console.log(`Device Y-axis in world coordinates: x = ${yAxisInWorld.x}, y = ${yAxisInWorld.y}, z = ${yAxisInWorld.z}`);
    // }

    // // Request permission and add event listener
    // function initOrientation() {
    //     if (typeof DeviceOrientationEvent.requestPermission === 'function') {
    //         beatSensElem.textContent = `IMU 0`;
    //         DeviceOrientationEvent.requestPermission()
    //             .then(permissionState => {
    //                 if (permissionState === 'granted') {
    //                     beatSensElem.textContent = `IMU 2`;
    //                     window.addEventListener('deviceorientation', handleOrientation);
    //                 } else {
    //                     // beatSensElem.textContent = `IMU 3`;
    //                     console.error('Permission denied for DeviceOrientationEvent');
    //                 }
    //             })
    //             .catch(
    //                 beatSensElem.textContent = `IMU 5`
    //             );
    //     } else {
    //         beatSensElem.textContent = `IMU 1`;
    //         // For browsers that don't require permission (non-Safari)
    //         window.addEventListener('deviceorientation', handleOrientation);
    //     }
    // }

    // Initialize the orientation tracking
    // initOrientation();

    // Initialize the orientation tracking
    // initOrientation();

    if ('AbsoluteOrientationSensor' in window) {
        try {
            const sensor = new AbsoluteOrientationSensor({
                frequency: 60, 
                referenceFrame: "device" 
            });
            sensor.addEventListener("reading", () => {
                if (trackAccel) {
                    let quaternion = {
                        x: sensor.quaternion[0],
                        y: sensor.quaternion[1],
                        z: sensor.quaternion[2],
                        w: sensor.quaternion[3]
                    };

                    let deviceHeightBelowGround = 8;
                    let groundPlaneRotationAngle = -0.175;

                    let intersection = getDeviceYAxisIntersectionWithGroundRotatedZ(quaternion, deviceHeightBelowGround, groundPlaneRotationAngle);
                    // beatSensElem.textContent = `x: ${intersection.x.toFixed(2)}, y: ${intersection.y.toFixed(2)}`;
                    let msg = {
                        type: 'accel',
                        x: -intersection.x,
                        y: intersection.y - 18,
                        z: 0
                    };
                    send(JSON.stringify(msg));
                }
            });
            sensor.addEventListener("error", (event) => {
                if (event.error.name === "NotReadableError") {
                }
            });
            sensor.start();
        } catch (error) {
        }
    }

    // navigator.serviceWorker.register('/sw.js', { scope: '/app1/' });

    paintBackground();

    window.onload = (event) => {
        socketInit();
    };

</script>

<style>

    body {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        color-scheme: dark;
        user-select: none;
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        font-size: 0;
        color: hsl(0, 0%, 80%);
        -webkit-user-select: none;
        background-color: black;
    }

    #background{
        position: fixed;
        top: 0vw;
        left: 0vh;
        width: 100vw;
        height: 100vh;
        z-index: -1;
    }

    /* chatgpt modal nonsense */

        /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            /* overflow: hidden;  */
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #2d0e38;
            margin: 2% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            font-size: 3vh;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        h2 {
            margin-top: 0;
        }

        /* --- Slider Layout (THIS IS THE CRUCIAL PART) --- */
        .slider-container {
            display: grid;
            grid-template-columns: 1fr auto; /* Col 1: flexible width, Col 2: content width */
            grid-template-rows: auto auto;    /* Row 1: label/value, Row 2: slider */
            align-items: center;
            row-gap: 5px;
            margin-bottom: 20px;
        }

        /* Style for the Label (e.g., "Hue") */
        .slider-container label {
            grid-column: 1 / 2;
            grid-row: 1 / 2;
            font-weight: bold;
            color: #e6e6e6; /* Ensure text color is visible */
            font-size: 1.2em;
            margin-right: 10px; /* Space between label and value */
        }

        /* Style for the Number Span (e.g., "180") */
        .slider-container span {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
            justify-self: end; /* Align to the right side of the column */
            font-family: monospace;
            font-size: 1.1em;
            color: #d8d8d8; /* Ensure text color is visible */
            background-color: #eee;
            padding: 2px 8px;
            border-radius: 4px;
            background-color: transparent;
        }

        /* Style for the Slider bar */
        .slider-container .slider {
            grid-column: 1 / 3; /* Span across both columns */
            grid-row: 2 / 3;
            width: 100%;
        }

        /* --- Slider Appearance --- */
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 15px;
            border-radius: 5px;
            background: #d3d3d3;
            outline: none;
            opacity: 0.8;
            transition: opacity .2s;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }



    /* end chatgpt modal nonsense */

    #profile-box{
        position: absolute;
        width: 20vw;
        height: 65vh;
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-color: hsla(0, 0%, 50%, 0.25) hsla(0, 0%, 0%, 0);
        scrollbar-width: none;
    }

    profile-button{
        position: relative;
        height: 10vh;
        margin: 0.5vw;
        border-radius: 0.5vw;
        display: block;
        background-color: hsla(0, 0%, 0%, 0.5);
    }

    profile-button:active{
        opacity: 0.5;
        transform: scale(0.97);
    }

    .profile-button-active{
        background-color: hsla(0, 0%, 50%, 0.5);
    }

    .profile-name {
        position: absolute;
        width: 65%;
        top: 50%;
        left: 10%;
        transform: translate(0%, -50%);
        font-size: 3vh;
    }

    .profile-playing {
        position: absolute;
        width: 8%;
        top: 50%;
        right: 10%;
        transform: translate(0%, -50%);
        text-align: center;
        font-size: 3vh;
        font-weight: bold;
    }

    #effects-box{
        position: absolute;
        top: 0;
        right: 6vw;
        width: 74vw;
        height: 100%;
        overflow: hidden;
    }

    .effects-table{
        position: absolute;
        padding: 0.25vw;
        box-sizing: border-box;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        opacity: 0;
        transform: scale(0.9);
        animation-duration: 200ms;
        animation-fill-mode: both;
        will-change: transform, opacity;
    }

    #page-up{
        position: absolute;
        right: 0.5vw;
        top: 0.5vw;
        width: 5vw;
        height: 15vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(180, 100%, 40%, 0.5);
    }

    #page-label{
        position: absolute;
        right: 0vw;
        top: 19vh;
        width: 6vw;
        height: 4vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #page-down{
        position: absolute;
        right: 0.5vw;
        top: 26vh;
        width: 5vw;
        height: 15vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(180, 100%, 40%, 0.5);
    }

    #page-random{
        position: absolute;
        right: 0.5vw;
        top: 44vh;
        width: 5vw;
        height: 8vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(180, 100%, 40%, 0.5);
    }

    #page-modifier{
        position: absolute;
        right: 0.5vw;
        top: 53vh;
        width: 5vw;
        height: 8vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(180, 100%, 40%, 0.5);
    }

    @keyframes prev-table-deactivate{
        0% {opacity: 1; transform: scale(1)}
        50% {opacity: 0; transform: scale(0.9)}
        100% {opacity: 0; transform: scale(0.9)}
    }

    @keyframes curr-table-activate{
        0% {opacity: 0; transform: scale(0.9)}
        50% {opacity: 0; transform: scale(0.9)}
        100% {opacity: 1; transform: scale(1)}
    }

    @keyframes prev-table-up{
        0% {opacity: 1; transform: translateY(0)}
        100% {opacity: 1; transform: translateY(100vh)}
    }

    @keyframes curr-table-up{
        0% {opacity: 1; transform: translateY(-100vh)}
        100% {opacity: 1; transform: translateY(0)}
    }

    @keyframes prev-table-down{
        0% {opacity: 1; transform: translateY(0)}
        100% {opacity: 1; transform: translateY(-100vh)}
    }

    @keyframes curr-table-down{
        0% {opacity: 1; transform: translateY(100vh)}
        100% {opacity: 1; transform: translateY(0)}
    }

    effect-button {
        position: relative;
        width: calc(20% - 0.5vw);
        height: calc(20% - 0.5vw);
        border-radius: 0.5vw;
        background-color: hsla(0, 0%, 0%, 0.5);
        display: inline-block;
        margin: 0.25vw;
    }

    .effect-button-active{
        background-color: hsla(0, 0%, 50%, 0.5);
    }

    .effect-button-pressed{
        background-color: hsla(220, 100%, 50%, 0.5);
        transform: scale(0.97);
    }

    .button-symbol{
        position: absolute;
        color: hsla(0, 0%, 100%, 0.07);
        font-size: 15vh;
        line-height: 20vh;
        text-align: center;
        width: 100%;
        height: 100%;
    }

    .button-name {
        position: absolute;
        width: 75%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        font-size: 2.5vh;
    }

    .button-bpm {
        position: absolute;
        bottom: 0.5vw;
        left: 0.5vw;
        text-align: center;
        font-size: 2vh;
        color: hsla(0, 0%, 100%, 0.4);
    }

    .button-length {
        position: absolute;
        top: 0.5vw;
        left: 0.5vw;
        text-align: center;
        font-size: 2vh;
        color: hsla(0, 0%, 100%, 0.4);
    }

    .button-loop {
        position: absolute;
        top: -0.2vw;
        right: 0.5vw;
        text-align: center;
        font-size: 3.5vh;
        color: hsla(0, 0%, 100%, 0.4);
    }

    .button-trigger {
        position: absolute;
        bottom: 0.5vw;
        right: 0.5vw;
        text-align: center;
        font-size: 1.5vh;
        color: hsla(0, 0%, 100%, 0.4);
    }

    
    #beat-sens{
        position: absolute;
        left: .5vw;
        /* margin: 0.5vw; */
        bottom: calc(22.5vh + .5vw);
        width: 18vw;
        height: 7vh;
        /* border-radius: 0.5vw; */
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        /* background-color: hsla(210, 100%, 40%, 0.5); */
    }

    #beat-sens-up{
        position: absolute;
        left: 0.5vw;
        /* margin: 0.5vw; */
        bottom: calc(16vh + .5vw);
        width: 9.25vw;
        height: 7vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(210, 100%, 40%, 0.5);
    }
    #beat-sens-down{
        position: absolute;
        left: 10.25vw;
        /* margin: 0.5vw; */
        bottom: calc(16vh + .5vw);
        width: 9.25vw;
        height: 7vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(210, 100%, 40%, 0.5);
    }

    #refresh{
        position: absolute;
        left: 0.5vw;
        /* margin: 0.5vw; */
        bottom: calc(8vh + .5vw);
        width: 9.25vw;
        height: 7vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(210, 100%, 40%, 0.5);
    }

    #laser-mode{
        position: absolute;
        left: 10.25vw;
        /* margin: 0.5vw; */
        bottom: calc(8vh + .5vw);
        width: 9.25vw;
        height: 7vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(150, 100%, 40%, 0.5);
    }

    #clear{
        position: absolute;
        left: 0.5vw;
        bottom: 0.5vw;
        width: 9.25vw;
        height: 7vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(330, 100%, 40%, 0.5);
    }

    #dev-mode{
        position: absolute;
        left: 10.25vw;
        bottom: 0.5vw;
        width: 9.25vw;
        height: 7vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsla(270, 100%, 40%, 0.5);
    }

    .gray{
        opacity: 0.5;
    }

    .button:active{
        opacity: 0.5;
        transform: scale(0.97);
    }
    
    ::-webkit-scrollbar {
        width: 0vw;
    }

</style>

</html>