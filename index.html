<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="height=device-height, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Light Show</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@100&display=swap">
</head>

<body>

    <template id="template-pad-item">
        <div class="pad-name"></div>
        <div class="pad-bpm"></div>
        <div class="pad-length"></div>
        <div class="pad-loop"></div>
        <div class="pad-button"></div>
    </template>

    <template id="template-profile-item">
        <div class="profile-name"></div>
        <div class="profile-playing"></div>
    </template>

    <div id="profile-list"></div>

    <div id="pad-table-wrapper"></div>

    <div id="rate-inc" class="button">+</div>
    <div id="rate-dec" class="button">—</div>
    <div id="rate-next"></div>
    <div id="rate-apply" class="button">Apply</div>
    <div id="rate-curr"></div>

    <div id="pads-clear" class="button">Clear</div>
</body>

<script>
    function socketInit() {
        console.log("socket init");

        socket = new WebSocket("ws://" + location.hostname + ":8765");

        socket.onopen = function () {
            console.log("socket open");

            socketAttempts = 0;

            if (!socketConnected) {
                socketConnected = true;
            }
        }

        socket.onclose = function () {
            console.log("socket close");
            if (socketConnected) {
                socketConnected = false;
            }
            let delay = 3000;
            if (socketAttempts == 0) {
                delay = 0;
            }
            setTimeout(() => {
                if (socket.readyState == WebSocket.CLOSED) {
                    socketInit();
                }
            }, delay);

            socketAttempts++;
        }

        socket.onerror = function () {
            console.log("socket error");
            socket.close();
        }

        socket.onmessage = function (event) {
            console.log("socket message");
            let msg = JSON.parse(event.data);
            console.log(msg);
            
            if(msg.config){
                config = msg.config
                for(let profile in config){
                    profiles[profile] = new ProfileItem(profile);
                    profileList.append(profiles[profile]);

                    padTables[profile] = new PadTable(profile);
                    padTableWrapper.append(padTables[profile]);

                    pads[profile] = {}
                    for(let pad in config[profile]){
                        pads[profile][pad] = new PadItem(profile, pad);
                        padTables[profile].append(pads[profile][pad]);
                    }
                    
                    if(!activeProfile){
                        console.log(profiles[profile]);
                        profiles[profile].activate();
                    }
                }
            }

            if(msg.status){
                for(let pad of padsCurr){
                    pads[pad[2]][pad[3]].deactivate();
                }
                for(let pad of msg.status.pads){
                    pads[pad[2]][pad[3]].activate();
                }
                padsCurr = msg.status.pads;

                rateCurr = msg.status.rate;
                rateCurrElem.textContent = rateCurr.toFixed(1);
                
                if(rateNext == false){
                    rateNext = rateCurr;
                    rateNextElem.textContent = rateNext.toFixed(1);;
                }

                if(startTime){
                    console.log(Date.now() - startTime);
                }
            }
        }
    }

    /////////////////////////////////////////////////////////////////////

    class PadItem extends HTMLElement {
        constructor(profile, pad) {
            super();

            this.appendChild(templatePadItem.content.cloneNode(true));

            this.profile = profile;
            this.pad = pad;

            this.button = config[profile][pad].button;
            this.toggle = this.button == "toggle";
            this.hold = this.button == "hold";
            this.add = this.button == "add";

            this.length = config[profile][pad].length;
            this.bpm = config[profile][pad].bpm;

            this.querySelector(".pad-name").textContent = this.pad;
            this.querySelector(".pad-length").textContent = this.length;
            this.querySelector(".pad-button").textContent = this.button;
            if(config[profile][pad].loop){
                this.querySelector(".pad-loop").textContent = "∞";
            }
            if(config[profile][pad].bpm){
                this.querySelector(".pad-bpm").textContent = this.bpm + " bpm";
            }

            this.active = false;

            //this.colorElem = this.querySelector(".pad-color");

            this.addEventListener('touchstart', this.press, false);
            this.addEventListener('mousedown', this.press, false);

            this.addEventListener('touchend', this.release, false);
            this.addEventListener('mouseup', this.release, false);
        }

        press(event){
            event.preventDefault();
            if(this.toggle){
                togglePad(this.profile, this.pad);
            }else{
                addPad(this.profile, this.pad);
            }
            this.classList.add('pressed');
        }

        release(event){
            event.preventDefault();
            if(this.hold){
                removePad(this.profile, this.pad);
            }
            this.classList.remove('pressed');
        }

        activate(){
            if(!this.active){
                this.classList.add('pad-item-active');
                this.active = true;
                profiles[this.profile].increasePlaying();
            }
        }

        deactivate(){
            if(this.active){
                this.classList.remove('pad-item-active');
                this.active = false;
                profiles[this.profile].decreasePlaying();
            }
        }
    }
    customElements.define('pad-item', PadItem);


    class ProfileItem extends HTMLElement {
        constructor(profile) {
            super();

            this.appendChild(templateProfileItem.content.cloneNode(true));

            this.profile = profile;

            this.nameElem = this.querySelector(".profile-name");
            this.nameElem.textContent = this.profile;

            this.playingElem = this.querySelector(".profile-playing");

            this.active = false;

            this.playing = 0;

            this.onclick = function (event) {
                event.preventDefault();
                profiles[activeProfile].deactivate();
                this.activate();
            };
        }

        setPlaying(){
            if(this.playing == 0){
                this.playingElem.textContent = "";
            }else{
                this.playingElem.textContent = this.playing;
            }
        }

        increasePlaying(){
            this.playing++;
            if(this.playing == 0){
                this.playingElem.textContent = "";
            }else{
                this.playingElem.textContent = this.playing;
            }
        }

        decreasePlaying(){
            this.playing--;
            if(this.playing == 0){
                this.playingElem.textContent = "";
            }else{
                this.playingElem.textContent = this.playing;
            }
        }

        activate(){
            if(!this.active){
                this.classList.add('profile-item-active');
                this.active = true;
                padTables[this.profile].show();
                activeProfile = this.profile;
            }
        }

        deactivate(){
            if(this.active){
                this.classList.remove('profile-item-active');
                this.active = false;
                padTables[this.profile].hide();
                activeProfile = null;
            }
        }
    }
    customElements.define('profile-item', ProfileItem);


    class PadTable extends HTMLElement {
        constructor(profile) {
            super();

            this.profile = profile;
        }

        show(){
            this.classList.add("pad-table-active");
        }

        hide(){
            this.classList.remove("pad-table-active");
        }
    }
    customElements.define('pad-table', PadTable);

    function addPad(profile, pad){
        let msg = {
            type: "add_pad",
            pad: pad,
            profile: profile
        };
        socket.send(JSON.stringify(msg));
        console.log(msg);
        startTime = Date.now();
    }

    function removePad(profile, pad){
        let msg = {
            type: "remove_pad",
            pad: pad,
            profile: profile
        };
        socket.send(JSON.stringify(msg));
        console.log(msg);
        startTime = Date.now();
    }

    function togglePad(profile, pad){
        let msg = {
            type: "toggle_pad",
            pad: pad,
            profile: profile
        };
        socket.send(JSON.stringify(msg));
        console.log(msg);
        startTime = Date.now();
    }

    function sendRate(rate){
        let msg = {
            type: "set_bpm",
            bpm: rate
        };
        socket.send(JSON.stringify(msg));
        console.log(msg);
        startTime = Date.now();
    }

    function sendClear(){
        let msg = {
            type: "clear_pads"
        };
        socket.send(JSON.stringify(msg));
        console.log(msg);
        startTime = Date.now();
    }

    var socket = null;
    var socketConnected = false;
    var socketAttempts = 0;

    var startTime = false;

    var config = {};
    var pads = {};
    var profiles = {};
    var padTables = {};

    var profileList = document.getElementById("profile-list");
    var padTableWrapper = document.getElementById("pad-table-wrapper");

    var templatePadItem = document.getElementById("template-pad-item");
    var templateProfileItem = document.getElementById("template-profile-item");

    var rateCurr = false;
    var rateNext = false;
    var padsCurr = [];
    var activeProfile = null;

    var rateCurrElem = document.getElementById("rate-curr");
    var rateNextElem = document.getElementById("rate-next");
    var rateApplyElem = document.getElementById("rate-apply");
    var rateIncElem = document.getElementById("rate-inc");
    var rateDecElem = document.getElementById("rate-dec");

    var padsClearElem = document.getElementById("pads-clear");

    // rateNextElem.focus();

    // rateNextElem.onblur = function(){
    //     fixRate();
    // }
    
    function changeValue(num){
        rateNext = Math.max(0.1, Math.min(300, rateNext + num));
        rateNextElem.textContent = rateNext.toFixed(1);
        timer = Math.max(16.67, timer * 0.9);
        timeout = setTimeout(changeValue, timer, num);
    }

    function stopValue(){
        clearTimeout(timeout);
        timer = 250;
    }

    var timer = 250;
    var timeout = null;

    rateIncElem.addEventListener('touchstart', startIncrease, false);
    rateIncElem.addEventListener('mousedown', startIncrease, false);
    rateIncElem.addEventListener('touchend', stopIncrease, false);
    rateIncElem.addEventListener('mouseup', stopIncrease, false);

    rateDecElem.addEventListener('touchstart', startDecrease, false);
    rateDecElem.addEventListener('mousedown', startDecrease, false);
    rateDecElem.addEventListener('touchend', stopDecrease, false);
    rateDecElem.addEventListener('mouseup', stopDecrease, false);


    function startIncrease(event){
        event.preventDefault();
        rateIncElem.classList.add('pressed');
        changeValue(0.1);
    }

    function stopIncrease(event){
        event.preventDefault();
        rateIncElem.classList.remove('pressed');
        stopValue();
    }

    function startDecrease(event){
        event.preventDefault();
        rateDecElem.classList.add('pressed');
        changeValue(-0.1);
    }

    function stopDecrease(event){
        event.preventDefault();
        rateDecElem.classList.remove('pressed');
        stopValue();
    }

    rateApplyElem.onclick = function () {
        sendRate(rateNext);
    }

    padsClearElem.onclick = function () {
        sendClear();
    }

    socketInit();

    window.oncontextmenu = function(event) {
        event.preventDefault();
        event.stopPropagation();
        return false;
    };

</script>

<style>
    body {
        color-scheme: dark;
        user-select: none;
        height: 100vh;
        margin: 0;
        padding: 0;
        font-family: sans-serif;
        font-size: 0;
        color: hsl(0, 0%, 80%);
        background-color: hsl(0, 0%, 4%);
    }

    #profile-list{
        position: absolute;
        width: 30vw;
        height: 70vh;
        overflow-y: auto;
        overflow-x: hidden;
        background-color: hsl(0, 0%, 8%);
    }

    profile-item{
        position: relative;
        height: 10vh;
        margin: 0.5vw;
        border-radius: 0.5vw;
        display: block;
        background-color: hsl(0, 0%, 15%);
        cursor: pointer;
    }

    profile-item:active{
        opacity: 0.8;
        transform: scale(0.97);
    }

    .profile-item-active{
        background-color: hsl(204, 100%, 24%);
    }

    .profile-name {
        position: absolute;
        width: 65%;
        top: 50%;
        left: 10%;
        transform: translate(0%, -50%);
        font-size: 3vh;
    }

    .profile-playing {
        position: absolute;
        width: 8%;
        top: 50%;
        right: 10%;
        transform: translate(0%, -50%);
        text-align: center;
        font-size: 3vh;
        font-weight: bold;
        color: hsl(204, 100%, 32%);
    }

    #pad-table-wrapper{
        position: absolute;
        right: 0;
        width: 70vw;
        height: 100vh;
        background-color: hsl(0, 0%, 6%);
        overflow: hidden;
    }

    pad-table{
        visibility: hidden;
        opacity: 0;
        transform: translateY(5%);
        position: absolute;
        width: calc(100% - 0.5vw);
        height: calc(100% - 0.5vw);
        padding: 0.25vw;
        overflow: hidden;
        transition: transform 150ms, opacity 150ms linear, visibility 150ms linear;
    }

    .pad-table-active{
        visibility: visible;
        opacity: 1;
        transform: translateY(0%);
    }

    @keyframes wipe{
        0% {opacity: 0; display: none;}
        90% {opacity: 0.9; display: none;}
        100% {opacity: 1; display: block;}
    }

    pad-item {
        position: relative;
        width: calc(20% - 0.5vw);
        height: calc(25% - 0.5vw);
        margin: 0.25vw;
        border-radius: 0.5vw;
        background-color: hsl(0, 0%, 12%);
        display: inline-block;
        cursor: pointer;
        transition: transform 50ms linear;
    }

    .pad-item-active{
        background-color: hsl(204, 100%, 24%);
    }

    .pressed{
        transform: scale(0.97);
    }

    .pad-name {
        position: absolute;
        width: 75%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        font-size: 3vh;
    }

    .pad-bpm {
        position: absolute;
        bottom: 0.5vw;
        left: 0.5vw;
        text-align: center;
        font-size: 2vh;
        color: hsla(0, 0%, 100%, 0.4);
    }

    .pad-length {
        position: absolute;
        top: 0.5vw;
        left: 0.5vw;
        text-align: center;
        font-size: 2vh;
        color: hsla(0, 0%, 100%, 0.4);
    }

    .pad-loop {
        position: absolute;
        top: -0.2vw;
        right: 0.5vw;
        text-align: center;
        font-size: 3.5vh;
        color: hsla(0, 0%, 100%, 0.4);
    }

    .pad-button {
        position: absolute;
        bottom: 0.5vw;
        right: 0.5vw;
        text-align: center;
        font-size: 1.5vh;
        color: hsla(0, 0%, 100%, 0.4);
    }

    #pads-clear{
        position: absolute;
        left: 9vw;
        bottom: 21vh;
        width: 12vw;
        height: 8vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsl(0, 100%, 24%);
        cursor: pointer;
    }

    #rate-curr {
        position: absolute;
        left: 14vw;
        bottom: 1vh;
        width: 6vw;
        height: 8vh;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: hsl(204, 100%, 32%);
    }

    #rate-next {
        position: absolute;
        left: 14vw;
        bottom: 10vh;
        width: 6vw;
        height: 8vh;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
        color: hsl(120, 100%, 32%);
    }

    #rate-apply{
        position: absolute;
        left: 1vw;
        bottom: 1vh;
        width: 11vw;
        height: 8vh;
        border-radius: 0.5vw;
        font-size: 3vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsl(204, 100%, 24%);
        cursor: pointer;
    }

    #rate-dec{
        position: absolute;
        left: 1vw;
        bottom: 10vh;
        width: 5vw;
        height: 8vh;
        border-radius: 0.5vw;
        font-size: 4vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsl(120, 100%, 24%);
        cursor: pointer;
    }

    #rate-inc{
        position: absolute;
        left: 7vw;
        bottom: 10vh;
        width: 5vw;
        height: 8vh;
        border-radius: 0.5vw;
        font-size: 6vh;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: hsl(120, 100%, 24%);
        cursor: pointer;
    }

    .button:active{
        opacity: 0.8;
        transform: scale(0.97);
    }

    input::-webkit-outer-spin-button,
    input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
    }
    
    ::-webkit-scrollbar {
        width: 1vw;
    }

    ::-webkit-scrollbar-thumb {
        background-color: hsl(0, 0%, 20%);
        border-radius: 1vw;
    }

</style>

</html>